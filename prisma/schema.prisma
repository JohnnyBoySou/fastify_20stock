generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String      @id @default(cuid())
  email                  String      @unique
  password               String
  name                   String?
  phone                  String?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt
  status                 Boolean     @default(true)
  resetPasswordToken     String?
  resetPasswordCode      String?
  resetPasswordExpires   DateTime?
  emailVerified          Boolean     @default(false)
  emailVerificationToken String?
  emailVerificationCode  String?
  emailVerificationCodeExpires DateTime?
  lastLoginAt            DateTime?
  roles                  String[]    @default(["user"])
  auditLogs              AuditLog[]
  movements              Movement[]
  ownedStores            Store[]     @relation("StoreOwner")
  stores                 StoreUser[]
  
  // Granular Permissions Relations
  userPermissions        UserPermission[]
  storePermissions       StorePermission[]
  createdUserPermissions UserPermission[] @relation("UserPermissionCreator")
  createdStorePermissions StorePermission[] @relation("StorePermissionCreator")
  createdPermissionTemplates PermissionTemplate[] @relation("PermissionTemplateCreator")
  createdPermissionAudits PermissionAuditLog[] @relation("PermissionAuditCreator")
  
  // Notifications
  notifications          Notification[]
  
  // Roadmap
  roadmaps               Roadmap[]

  // Media
  media                  UserMedia[]

  // Quotes
  quotes                 Quote[]

  // Customers
  customers              Customer[]

  @@map("users")
}


model Product {
  id              String        @id @default(cuid())
  name            String
  description     String?
  unitOfMeasure   UnitOfMeasure
  referencePrice  Decimal       @db.Decimal(10, 2)
  supplierId      String?
  storeId         String
  stockMin        Int
  stockMax        Int
  alertPercentage Int           @db.SmallInt
  status          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  store           Store         @relation(fields: [storeId], references: [id])
  supplier        Supplier?     @relation(fields: [supplierId], references: [id])
  movements       Movement[]
  categories      ProductCategory[]
  media           ProductMedia[]

  // Quotes
  quotes          QuoteItem[]
}

model Category {
  id          String     @id @default(cuid())
  name        String
  description String?
  code        String?
  status      Boolean    @default(true)
  color       String?
  icon        String?
  parentId    String?
  storeId     String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  store       Store      @relation(fields: [storeId], references: [id])
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    ProductCategory[]
  
  @@unique([code, storeId])
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  createdAt  DateTime @default(now())
  
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([productId, categoryId])
  @@map("ProductCategory")
}

model Supplier {
  id            String                @id @default(cuid())
  corporateName String
  cnpj          String                @unique
  tradeName     String?
  status        Boolean               @default(true)
  cep           String?
  city          String?
  state         String?
  address       String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  products      Product[]
  movements     Movement[]
  responsibles  SupplierResponsible[]
  media         SupplierMedia[]
}

model SupplierResponsible {
  id         String   @id @default(cuid())
  name       String
  phone      String?
  email      String?
  cpf        String?
  status     Boolean  @default(true)
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])
}
model Store {
  id        String      @id @default(cuid())
  ownerId   String
  name      String
  cnpj      String      @unique
  email     String?
  phone     String?
  status    Boolean     @default(true)
  cep       String?
  city      String?
  state     String?
  address   String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  products  Product[]
  categories Category[]
  movements Movement[]
  owner     User        @relation("StoreOwner", fields: [ownerId], references: [id])
  users     StoreUser[]
  
  // Granular Permissions Relations
  userPermissions UserPermission[]
  storePermissions StorePermission[]
  
  // Roadmap
  roadmaps  Roadmap[]

  // Media
  media     StoreMedia[]
}

model StoreUser {
  id      String    @id @default(cuid())
  storeId String
  userId  String
  role    StoreRole @default(STAFF)
  store   Store     @relation(fields: [storeId], references: [id])
  user    User      @relation(fields: [userId], references: [id])

  @@unique([storeId, userId])
}

model AuditLog {
  id        String    @id @default(cuid())
  entity    Entity
  entityId  String
  action    LogAction
  userId    String?
  before    Json?
  after     Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User?     @relation(fields: [userId], references: [id])
}

model Movement {
  id          String         @id @default(cuid())
  type        MovementType
  quantity    Int
  storeId     String
  productId   String
  supplierId  String?        // fornecedor opcional, pode variar
  batch       String?        // lote
  expiration  DateTime?      // validade
  price       Decimal?       @db.Decimal(10,2) // preço da unidade na movimentação
  note        String?        // observações
  balanceAfter Int?          // estoque após a movimentação

  // Campos de verificação
  verified         Boolean?   @default(false)
  verifiedAt       DateTime?
  verifiedBy       String?
  verificationNote String?

  // Campos de cancelamento
  cancelled         Boolean   @default(false)
  cancelledAt       DateTime?
  cancelledBy       String?
  cancellationReason String?

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relacionamentos
  store       Store          @relation(fields: [storeId], references: [id])
  product     Product        @relation(fields: [productId], references: [id])
  supplier    Supplier?      @relation(fields: [supplierId], references: [id])
  userId      String?        // quem registrou
  user        User?          @relation(fields: [userId], references: [id])
}

enum MovementType {
  ENTRADA
  SAIDA
  PERDA
}


enum LogAction {
  CREATE
  UPDATE
  DELETE
}

enum Entity {
  PRODUCT
  STORE
  USER
}

enum StoreRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
}

enum UnitOfMeasure {
  UNIDADE
  KG
  L
  ML
  M
  CM
  MM
  UN
  DZ
  CX
  PCT
  KIT
  PAR
  H
  D
}

// ================================
// GRANULAR PERMISSIONS MODELS
// ================================

model UserPermission {
  id         String    @id @default(cuid())
  userId     String
  action     String    // Action enum from middleware
  resource   String?   // Specific resource (e.g., product:123) or * for all
  storeId    String?   // Store-specific permission
  grant      Boolean   @default(true) // true = grant, false = deny
  conditions Json?     // JSON conditions for when permission applies
  expiresAt  DateTime? // When permission expires (null = never)
  reason     String?   // Reason for permission
  createdAt  DateTime  @default(now())
  createdBy  String    // Who created this permission
  
  // Relations
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store      Store?    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  creator    User      @relation("UserPermissionCreator", fields: [createdBy], references: [id])
  
  @@map("UserPermission")
}

model StorePermission {
  id           String     @id @default(cuid())
  userId       String
  storeId      String
  storeRole    StoreRole  // Role within the store
  permissions  Json       // Array of actions permitted for this store role
  conditions   Json?      // JSON conditions for when permissions apply
  expiresAt    DateTime?  // When permission expires (null = never)
  createdAt    DateTime   @default(now())
  createdBy    String     // Who created this permission
  
  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  store        Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  creator      User       @relation("StorePermissionCreator", fields: [createdBy], references: [id])
  
  @@unique([userId, storeId])
  @@map("StorePermission")
}

model PermissionTemplate {
  id           String    @id @default(cuid())
  name         String    @unique
  description  String?
  permissions  Json      // Array of actions included in this template
  conditions   Json?     // Default conditions for permissions in this template
  isDefault    Boolean   @default(false) // Whether this is a system default template
  createdAt    DateTime  @default(now())
  createdBy    String    // Who created this template
  
  // Relations
  creator      User      @relation("PermissionTemplateCreator", fields: [createdBy], references: [id])
  
  @@map("PermissionTemplate")
}

model PermissionAuditLog {
  id             String   @id @default(cuid())
  permissionId   String   // ID of the permission that was changed
  permissionType String   // 'user' or 'store'
  action         String   // 'created', 'updated', 'deleted', 'expired'
  userId         String   // User affected by the change
  changes        Json?    // JSON of what changed (for updates)
  reason         String?  // Reason for the change
  createdAt      DateTime @default(now())
  createdBy      String   // Who made the change
  
  // Relations
  creator        User     @relation("PermissionAuditCreator", fields: [createdBy], references: [id])
  
  @@map("PermissionAuditLog")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           // Usuário que receberá a notificação
  title       String           // Título da notificação
  message     String           // Mensagem da notificação
  type        NotificationType @default(INFO) // Tipo da notificação
  priority    NotificationPriority @default(MEDIUM) // Prioridade da notificação
  isRead      Boolean          @default(false) // Se foi lida
  readAt      DateTime?        // Quando foi lida
  data        Json?            // Dados adicionais da notificação (opcional)
  actionUrl   String?          // URL de ação (opcional)
  expiresAt   DateTime?        // Quando a notificação expira (opcional)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

enum NotificationType {
  INFO        // Informação geral
  SUCCESS     // Sucesso/confirmação
  WARNING     // Aviso
  ERROR       // Erro
  STOCK_ALERT // Alerta de estoque
  MOVEMENT    // Movimentação de estoque
  PERMISSION  // Permissão
  SYSTEM      // Sistema
}

enum NotificationPriority {
  LOW         // Baixa prioridade
  MEDIUM      // Média prioridade
  HIGH        // Alta prioridade
  URGENT      // Urgente
}

// === CHAT MODELS ===
model ChatSession {
  id        String        @id @default(cuid())
  userId    String
  storeId   String?
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(cuid())
  content   String      // Conteúdo da mensagem (pergunta do usuário OU resposta da IA)
  isFromUser Boolean     @default(true) // true = usuário, false = IA
  sessionId String
  context   Json?       // Contexto adicional (storeId, userId, etc.)
  options   Json?       // Opções do LLM (temperature, numPredict, etc.)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("chat_messages")
}



//Roadmap Feature

model Roadmap {
  id          String       @id @default(cuid())
  storeId     String?      // Roadmap pode ser associado a uma loja específica
  userId      String?      // Ou a um usuário (roadmap pessoal)
  title       String
  description String?
  status      RoadmapStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  store       Store?       @relation(fields: [storeId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])
  milestones  Milestone[]

  @@map("roadmaps")
}

model Milestone {
  id          String          @id @default(cuid())
  roadmapId   String
  title       String
  description String?
  status      MilestoneStatus @default(PENDING)
  progress    Int              @default(0)  // % concluída (0–100)
  order       Int              @default(0)  // posição na timeline
  startDate   DateTime?
  endDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  roadmap     Roadmap          @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

enum RoadmapStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

//Upload Feature

model Media {
  id          String   @id @default(cuid())
  url         String   // link público da imagem (ex: Cloudinary, S3, etc.)
  name        String?  // nome do arquivo
  type        String?  // tipo MIME (ex: image/png)
  size        Int?     // tamanho em bytes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relações
  productMedia   ProductMedia[]
  supplierMedia  SupplierMedia[]
  userMedia      UserMedia[]
  storeMedia     StoreMedia[]
    
  @@map("media")
}

 

// tabelas de ligação (muitos-para-muitos com metadados opcionais)
model ProductMedia {
  id        String   @id @default(cuid())
  productId String
  mediaId   String
  isPrimary Boolean  @default(false) // define se é a imagem principal do produto

  product   Product  @relation(fields: [productId], references: [id])
  media     Media    @relation(fields: [mediaId], references: [id])

  @@map("product_media")
}

model SupplierMedia {
  id         String   @id @default(cuid())
  supplierId String
  mediaId    String

  supplier   Supplier @relation(fields: [supplierId], references: [id])
  media      Media    @relation(fields: [mediaId], references: [id])

  @@map("supplier_media")
}

model UserMedia {
  id       String @id @default(cuid())
  userId   String
  mediaId  String

  user     User   @relation(fields: [userId], references: [id])
  media    Media  @relation(fields: [mediaId], references: [id])

  @@map("user_media")
}

model StoreMedia {
  id       String @id @default(cuid())
  storeId  String
  mediaId  String

  store    Store  @relation(fields: [storeId], references: [id])
  media    Media  @relation(fields: [mediaId], references: [id])

  @@map("store_media")
}


//Quotation Feature
model Quote {
  id            String      @id @default(cuid())
  userId        String
  title         String
  description   String?
  publicId      String      @unique @default(uuid())
  authCode      String      @default(uuid()) // Código de autorização para acesso público
  status        QuoteStatus @default(DRAFT)
  total         Decimal     @db.Decimal(10,2)
  subtotal      Decimal     @db.Decimal(10,2) // total antes de desconto/juros
  discount      Decimal?    @db.Decimal(10,2)
  interest      Decimal?    @db.Decimal(10,2) // juros somados, se houver
  paymentType   PaymentType @default(UNDEFINED)
  paymentTerms  String?     // descrição livre, ex: "6x sem juros no cartão"
  paymentDueDays Int?       // ex: 15 dias p/ pagamento no boleto
  expiresAt     DateTime?   // validade do orçamento
  observations  String?     // campo livre pro usuário
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  items         QuoteItem[]
  installments  QuoteInstallment[]
  user          User        @relation(fields: [userId], references: [id])
}

model QuoteItem {
  id         String   @id @default(cuid())
  quoteId    String
  productId  String
  quantity   Int
  unitPrice  Decimal   @db.Decimal(10,2)
  subtotal   Decimal   @db.Decimal(10,2)
  discount   Decimal?  @db.Decimal(10,2)
  note       String?

  quote      Quote     @relation(fields: [quoteId], references: [id])
  product    Product   @relation(fields: [productId], references: [id])
}

model QuoteInstallment {
  id         String   @id @default(cuid())
  quoteId    String
  number     Int      // ex: parcela 1, 2, 3...
  dueDate    DateTime
  amount     Decimal  @db.Decimal(10,2)
  interest   Decimal? @db.Decimal(10,2)

  quote      Quote    @relation(fields: [quoteId], references: [id])
}

enum PaymentType {
  UNDEFINED
  PIX
  BOLETO
  CREDIT_CARD
  CASH
  TRANSFER
}

enum QuoteStatus {
  DRAFT          // Orçamento ainda em edição (não publicado)
  PUBLISHED      // Link público ativo (cliente pode visualizar)
  SENT           // Enviado para o cliente (por e-mail/link/WhatsApp)
  VIEWED         // Cliente visualizou o orçamento (tracking opcional)
  APPROVED       // Cliente aprovou (pronto para virar venda)
  REJECTED       // Cliente recusou
  EXPIRED        // Passou da data de validade (expiresAt)
  CONVERTED      // Convertido em venda / movimentação
  CANCELED       // Cancelado pelo usuário
}


//Payment Feature
model Customer {
  id           String    @id @default(cuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id])
  planId       String?
  plan         Plan?     @relation(fields: [planId], references: [id])
  status       CustomerStatus @default(ACTIVE)
  renewalDate  DateTime?
  trialEndsAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  invoices     Invoice[]
}

model Plan {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(10,2)
  interval    PlanInterval // MONTHLY, YEARLY
  features    Json?
  customers   Customer[]
}

model Invoice {
  id                String         @id @default(cuid())
  customerId        String
  customer          Customer       @relation(fields: [customerId], references: [id])
  amount            Decimal        @db.Decimal(10,2)
  status            InvoiceStatus
  gatewayPaymentId  String?        // ID de referência no Abacate Pay
  paymentDate       DateTime?
  createdAt         DateTime       @default(now())
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  TRIAL
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
}
