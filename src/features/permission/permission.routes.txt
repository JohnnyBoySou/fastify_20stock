import type { FastifyInstance } from 'fastify'
import { PermissionController } from './permission.controller'
import { PermissionSchemas } from './permission.schema'

import { Middlewares } from '@/middlewares'

export async function PermissionRoutes(fastify: FastifyInstance) {
  // ================================
  // ROTAS PARA PERMISSÕES CUSTOMIZADAS
  // ================================

  // POST /permissions/user - Criar permissão customizada
  fastify.post('/user', {
    schema: PermissionSchemas.createUserPermission,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'CREATE')],
    handler: PermissionController.createUserPermission,
  })

  // GET /permissions/user/:userId - Listar permissões de usuário
  fastify.get('/user/:userId', {
    schema: PermissionSchemas.getUserPermissions,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'READ')],
    handler: PermissionController.getUserPermissions,
  })

  // PUT /permissions/user/:id - Atualizar permissão customizada
  fastify.put('/user/:id', {
    schema: PermissionSchemas.updateUserPermission,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'UPDATE')],
    handler: PermissionController.updateUserPermission,
  })

  // DELETE /permissions/user/:id - Deletar permissão customizada
  fastify.delete('/user/:id', {
    schema: PermissionSchemas.deleteUserPermission,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'DELETE')],
    handler: PermissionController.deleteUserPermission,
  })

  // ================================
  // ROTAS PARA PERMISSÕES DE LOJA
  // ================================

  // POST /permissions/store - Definir permissões de usuário em loja
  fastify.post('/store', {
    schema: PermissionSchemas.setStoreUserPermissions,
    preHandler: [Middlewares.auth, Middlewares.permission('STORES', 'MANAGE_USERS')],
    handler: PermissionController.setStoreUserPermissions,
  })

  // GET /permissions/store/:storeId - Listar permissões de loja
  fastify.get('/store/:storeId', {
    schema: PermissionSchemas.getStoreUserPermissions,
    preHandler: [Middlewares.auth, Middlewares.permission('STORES', 'READ')],
    handler: PermissionController.getStoreUserPermissions,
  })

  // ================================
  // ROTAS PARA CONSULTAS E RELATÓRIOS
  // ================================

  // GET /permissions/effective/:userId - Obter permissões efetivas
  fastify.get('/effective/:userId', {
    schema: PermissionSchemas.getUserEffectivePermissions,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'READ')],
    handler: PermissionController.getUserEffectivePermissions,
  })

  // POST /permissions/test - Testar permissão específica
  fastify.post('/test', {
    schema: PermissionSchemas.testPermission,
    preHandler: [Middlewares.auth, Middlewares.permission('USERS', 'READ')],
    handler: PermissionController.testPermission,
  })

  // GET /permissions/stats - Obter estatísticas de permissões
  fastify.get('/stats', {
    schema: PermissionSchemas.getPermissionStats,
    preHandler: [Middlewares.auth, Middlewares.permission('AUDIT_LOGS', 'VIEW')],
    handler: PermissionController.getPermissionStats,
  })
}
